<!DOCTYPE html>  <html> <head>   <title>deploy.py</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               deploy.py             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Preliminaries</h2>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><a href="http://packages.python.org/GitPython/0.3.1/reference.html">GitPython</a></p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">git</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">ftplib</span>
<span class="kn">import</span> <span class="nn">os</span>

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Attempt to import readline, if available we will use that
<a href="http://docs.python.org/library/readline.html?highlight=readline#readline">readline</a>
is not available outside of unix.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">readline</span>
    <span class="n">gotReadline</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">gotReadline</span> <span class="o">=</span> <span class="bp">False</span>


</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h1>Deploy</h1>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="k">class</span> <span class="nc">Deploy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dry</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deletedFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry</span> <span class="o">=</span> <span class="n">dry</span>
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Repo will first attempt to find .git in the cwd, then work its way up</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>We change dir to the repo working dir so file references we get from
the repo makes sense.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">config_reader</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setVerbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>raw_input_default</h2>

<p>Wraps raw_input/readline to show default values</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">def</span> <span class="nf">raw_input_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">gotReadline</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">pre_input_hook</span><span class="p">():</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">redisplay</span><span class="p">()</span>

            <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="n">pre_input_hook</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">raw_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>No readline :(</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="k">if</span><span class="p">(</span><span class="n">default</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="s">&quot;[&quot;</span> <span class="o">+</span> <span class="n">default</span> <span class="o">+</span> <span class="s">&quot;] &quot;</span> <span class="o">+</span> <span class="n">prompt</span>

            <span class="n">val</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">checkFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployVersion</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deployVersion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">deployVersion</span><span class="p">)</span><span class="o">.</span><span class="n">name_rev</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;lastDeploy&quot;</span><span class="p">):</span>
            <span class="n">lastDeploy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;lastDeploy&quot;</span><span class="p">)</span>
            <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">lastDeploy</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">deployVersion</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;No previous deployments, adding all files&quot;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">Git</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span><span class="o">.</span><span class="n">ls_files</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Added files:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileAdded</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">iter_change_type</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="n">fileAdded</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileAdded</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Updated files&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileUpdated</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">iter_change_type</span><span class="p">(</span><span class="s">&#39;M&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="n">fileUpdated</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileUpdated</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Deleted files&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileDeleted</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">iter_change_type</span><span class="p">(</span><span class="s">&#39;D&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="n">fileDeleted</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileDeleted</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Renamed files&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileRenamed</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">iter_change_type</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  From: &quot;</span><span class="p">,</span> <span class="n">fileRenamed</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot; to &quot;</span><span class="p">,</span> <span class="n">fileRenamed</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connectFTP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rebuild_config</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteServer&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteServer&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">rebuild_config</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_input_default</span><span class="p">(</span><span class="s">&quot;Server: &quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteUser&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteUser&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">rebuild_config</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_input_default</span><span class="p">(</span><span class="s">&quot;Username: &quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">savePass</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remotePassword&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remotePassword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remotePassword&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savePass</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remotePassword</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="s">&quot;Password: &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteDir&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteDir&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">rebuild_config</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_input_default</span><span class="p">(</span><span class="s">&quot;Remote directory: &quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;savePass&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remotePassword&quot;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Save password (y/n):&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;y&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">savePass</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span> <span class="o">=</span> <span class="n">ftplib</span><span class="o">.</span><span class="n">FTP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remotePassword</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ftplib</span><span class="o">.</span><span class="n">all_errors</span> <span class="k">as</span> <span class="n">connectionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Error connecting to server: &quot;</span><span class="p">,</span> <span class="n">connectionError</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Retry (y/n)?: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;y&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connectFTP</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">exit</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rootFolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span>

    <span class="k">def</span> <span class="nf">parseDirectories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="p">:</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span>
            <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cwd</span><span class="p">:</span>
                    <span class="n">cwd</span><span class="p">[</span><span class="nb">dir</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">cwd</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">[</span><span class="nb">dir</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">checkDirectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="n">cwd</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootFolder</span>
            <span class="n">folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Checking folders under&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="p">)</span>

            <span class="k">for</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">subFolders</span> <span class="ow">in</span> <span class="n">folders</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Checking &quot;</span><span class="p">,</span> <span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Creating previously non-existing folder&quot;</span><span class="p">,</span> <span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">mkd</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkDirectories</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">subFolders</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cwd</span> <span class="o">==</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootFolder</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deleteFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deletedFiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Deleting &quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Error: &quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="s">&quot; did not exist online, could have been deletet by other means&quot;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">uploadFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Uploading&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">storbinary</span><span class="p">(</span><span class="s">&quot;STOR &quot;</span> <span class="o">+</span> <span class="nb">file</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">mkd</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>sumodule folder allready exists</p>             </td>             <td class="code">               <div class="highlight"><pre>
                    <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handleSubmodules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">subModule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">subModule</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="n">Deploy</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">dry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dry</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">ftp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">rootFolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootFolder</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">subModule</span><span class="o">.</span><span class="n">path</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">checkFiles</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&quot;commit&quot;</span><span class="p">])</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">parseDirectories</span><span class="p">()</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">checkDirectories</span><span class="p">()</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">deleteFiles</span><span class="p">()</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">uploadFiles</span><span class="p">()</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">updateLast</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">handleSubmodules</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">updateLast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">infoWriter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">config_writer</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span><span class="p">:</span>
            <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;lastDeploy&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployVersion</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">saveConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">infoWriter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">config_writer</span><span class="p">()</span>
        <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;remoteUser&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span><span class="p">)</span>
        <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;remoteDir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">)</span>
        <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;remoteServer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savePass</span><span class="p">:</span>
            <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;remotePassword&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remotePassword</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;verbosity&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">verbosity</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 