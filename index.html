<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>deploy.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>deploy.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <h2>Preliminaries</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p><a href="http://packages.python.org/GitPython/0.3.1/reference.html">GitPython</a></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">git</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">ftplib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">getopt</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">fnmatch</span> <span class="kn">import</span> <span class="n">fnmatch</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>See <a href="config.html">config</a></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="o">*</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Attempt to import readline, if available we will use that
<a href="http://docs.python.org/library/readline.html?highlight=readline#readline">readline</a>
is not available outside of unix.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">readline</span>
    <span class="n">gotReadline</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">gotReadline</span> <span class="o">=</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <h1>Deploy</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Deploy</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dry</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deletedFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry</span> <span class="o">=</span> <span class="n">dry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Repo will first attempt to find .git in the cwd, then work its way up</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>We change dir to the repo working dir so file references we get from
the repo makes sense.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span> <span class="o">=</span> <span class="n">ConfigReader</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configGlobal</span> <span class="o">=</span> <span class="n">ConfigReader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignored</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configGlobal</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;global&quot;</span><span class="p">,</span> <span class="s">&quot;ignore&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignored</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configGlobal</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;global&quot;</span><span class="p">,</span> <span class="s">&quot;ignore&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignored</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;deploy.cfg&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">setVerbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Use <a href="https://en.wikipedia.org/wiki/Glob_(programming)">glob</a> matching to check if a file
is in the ignore list.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">is_ignored</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">True</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fnmatch</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignored</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Wrap raw_input/readline to show default values</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">raw_input_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>If we have readline, insert the default text after prompting
this way the user can delete the default and replace it</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">gotReadline</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">def</span> <span class="nf">pre_input_hook</span><span class="p">():</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">redisplay</span><span class="p">()</span>

            <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="n">pre_input_hook</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">raw_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">readline</span><span class="o">.</span><span class="n">set_pre_input_hook</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>If we do not have readline, prompt for text with the default
value placed in square braces imediately behind it. If we get
an empty string back, set the returned value to the default</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">default</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="s">&quot;[&quot;</span> <span class="o">+</span> <span class="n">default</span> <span class="o">+</span> <span class="s">&quot;] &quot;</span> <span class="o">+</span> <span class="n">prompt</span>

            <span class="n">val</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">default</span>
            <span class="k">return</span> <span class="n">val</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Use git to check for files changed since last deploy.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">checkFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployVersion</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deployVersion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">deployVersion</span><span class="p">)</span><span class="o">.</span><span class="n">name_rev</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Check the config and see if a last deployment exists</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;lastDeploy&quot;</span><span class="p">):</span>
            <span class="n">lastDeploy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;lastDeploy&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Create a diff of changes between last deploy and current HEAD</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">lastDeploy</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">deployVersion</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>In case no previous deployments exists</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;No previous deployments, adding all files&quot;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Grab all files in the repo</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">Git</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span><span class="o">.</span><span class="n">ls_files</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;File:&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="s">&quot;is ignored&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
            <span class="k">return</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Iterate through all changes, using <a href="http://packages.python.org/GitPython/0.3.1/reference.html#git.diff.DiffIndex">iter_change_type</a>
to keep track of whats what</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Added files:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileAdded</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">iter_change_type</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">(</span><span class="n">fileAdded</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;File:&quot;</span><span class="p">,</span> <span class="n">fileAdded</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;is ignored&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="n">fileAdded</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileAdded</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Updated files&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileUpdated</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">iter_change_type</span><span class="p">(</span><span class="s">&#39;M&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">(</span><span class="n">fileUpdated</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;File:&quot;</span><span class="p">,</span> <span class="n">fileUpdated</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;is ignored&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="n">fileUpdated</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileUpdated</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Deleted files&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileDeleted</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">iter_change_type</span><span class="p">(</span><span class="s">&#39;D&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="n">fileDeleted</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deletedFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileDeleted</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Renamed files&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fileRenamed</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">iter_change_type</span><span class="p">(</span><span class="s">&#39;R&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;  From: &quot;</span><span class="p">,</span> <span class="n">fileRenamed</span><span class="o">.</span><span class="n">a_blob</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot; to &quot;</span><span class="p">,</span> <span class="n">fileRenamed</span><span class="o">.</span><span class="n">b_blob</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Setup FTP settings</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">connectFTP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rebuild_config</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>The following checks the config file for already set values.</p>
<p>If the value is not found the user will be prompted for information.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteServer&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteServer&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">rebuild_config</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_input_default</span><span class="p">(</span><span class="s">&quot;Server: &quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteUser&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteUser&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">rebuild_config</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_input_default</span><span class="p">(</span><span class="s">&quot;Username: &quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">savePass</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remotePassword&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remotePassword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remotePassword&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savePass</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remotePassword</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="s">&quot;Password: &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteDir&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remoteDir&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">rebuild_config</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_input_default</span><span class="p">(</span><span class="s">&quot;Remote directory: &quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;savePass&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;remotePassword&quot;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Save password (y/n):&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;y&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">savePass</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Trim the remote dir of slashes the first slash will be prepended by the system.
This means that all remote directories must be absolute.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Attempt to connect to the remote ftp server and change directory to the specified
remote folder.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span> <span class="o">=</span> <span class="n">ftplib</span><span class="o">.</span><span class="n">FTP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remotePassword</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ftplib</span><span class="o">.</span><span class="n">all_errors</span> <span class="k">as</span> <span class="n">connectionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Error connecting to server: &quot;</span><span class="p">,</span> <span class="n">connectionError</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Retry (y/n)?: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;y&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connectFTP</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">exit</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rootFolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Parse folders from the changed files</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">parseDirectories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Run through each updated file and generate a dictionary tree of expected remote folders</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="p">:</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span>
            <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cwd</span><span class="p">:</span>
                    <span class="n">cwd</span><span class="p">[</span><span class="nb">dir</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">cwd</span> <span class="o">=</span> <span class="n">cwd</span><span class="p">[</span><span class="nb">dir</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>Check remote for expected folders</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">checkDirectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">folders</span><span class="o">=</span><span class="p">{}):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Instead of keeping track of nesting levels etc, we use absolute paths on the remote server.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">cwd</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootFolder</span>
            <span class="n">folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Checking folders under&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="p">)</span>

            <span class="k">for</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">subFolders</span> <span class="ow">in</span> <span class="n">folders</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Checking &quot;</span><span class="p">,</span> <span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>To test for the remote directory we use the tried and tested "better to ask forgiveness"</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Creating previously non-existing folder&quot;</span><span class="p">,</span> <span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">mkd</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Recursively check the sub-folders of the current folder</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="bp">self</span><span class="o">.</span><span class="n">checkDirectories</span><span class="p">(</span><span class="n">cwd</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">subFolders</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cwd</span> <span class="o">==</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootFolder</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>Delete remote files if they have been deleted from the repository</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">deleteFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deletedFiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Deleting &quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Error: &quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="s">&quot; did not exist online, could have been deletet by other means&quot;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>Upload local files to remote</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">uploadFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Uploading&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">storbinary</span><span class="p">(</span><span class="s">&quot;STOR &quot;</span> <span class="o">+</span> <span class="nb">file</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">mkd</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>sumodule folder allready exists</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">handleSubmodules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">subModule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">subModule</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="n">Deploy</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">dry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dry</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">ftp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">rootFolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootFolder</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">subModule</span><span class="o">.</span><span class="n">path</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">checkFiles</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&quot;commit&quot;</span><span class="p">])</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">parseDirectories</span><span class="p">()</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">checkDirectories</span><span class="p">()</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">deleteFiles</span><span class="p">()</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">uploadFiles</span><span class="p">()</span>
            <span class="n">dep</span><span class="o">.</span><span class="n">updateLast</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">handleSubmodules</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">handleRename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;target_specific_files&quot;</span><span class="p">):</span>
            <span class="n">swapMap</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configReader</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;target_specific_files&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">swapMap</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatedFiles</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s">&quot;Replacing&quot;</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="s">&quot;with&quot;</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">original</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ftp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">updateLast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">infoWriter</span> <span class="o">=</span> <span class="n">ConfigWriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry</span><span class="p">:</span>
            <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;lastDeploy&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployVersion</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">saveConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">infoWriter</span> <span class="o">=</span> <span class="n">ConfigWriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;remoteUser&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteUser</span><span class="p">)</span>
        <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;remoteDir&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">)</span>
        <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;remoteServer&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteServer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">savePass</span><span class="p">:</span>
            <span class="n">infoWriter</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span> <span class="s">&#39;remotePassword&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remotePassword</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;verbosity&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">verbosity</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;dry&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&quot;commit&quot;</span><span class="p">:</span> <span class="s">&quot;HEAD&quot;</span><span class="p">,</span>
        <span class="s">&quot;verbose&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>

    <span class="n">options</span><span class="p">,</span> <span class="n">arguments</span> <span class="o">=</span> <span class="n">getopt</span><span class="o">.</span><span class="n">getopt</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s">&quot;vn&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;dry-run&quot;</span><span class="p">,</span> <span class="s">&quot;verbose&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="s">&quot;--dry-run&quot;</span><span class="p">):</span>
            <span class="n">args</span><span class="p">[</span><span class="s">&quot;dry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="s">&quot;--verbose&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">args</span><span class="p">[</span><span class="s">&quot;verbose&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">deploy</span> <span class="o">=</span> <span class="n">Deploy</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">&quot;verbose&quot;</span><span class="p">],</span> <span class="n">dry</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">&quot;dry&quot;</span><span class="p">],</span> <span class="n">target</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">&quot;target&quot;</span><span class="p">])</span>

    <span class="n">deploy</span><span class="o">.</span><span class="n">checkFiles</span><span class="p">(</span><span class="s">&quot;HEAD&quot;</span><span class="p">)</span>
    <span class="n">deploy</span><span class="o">.</span><span class="n">parseDirectories</span><span class="p">()</span>
    <span class="n">deploy</span><span class="o">.</span><span class="n">connectFTP</span><span class="p">()</span>
    <span class="n">deploy</span><span class="o">.</span><span class="n">checkDirectories</span><span class="p">()</span>
    <span class="n">deploy</span><span class="o">.</span><span class="n">deleteFiles</span><span class="p">()</span>
    <span class="n">deploy</span><span class="o">.</span><span class="n">uploadFiles</span><span class="p">()</span>
    <span class="n">deploy</span><span class="o">.</span><span class="n">saveConfig</span><span class="p">()</span>
    <span class="n">deploy</span><span class="o">.</span><span class="n">updateLast</span><span class="p">()</span>
    <span class="n">deploy</span><span class="o">.</span><span class="n">handleSubmodules</span><span class="p">()</span>
    <span class="n">deploy</span><span class="o">.</span><span class="n">handleRename</span><span class="p">()</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Deploy&quot;</span><span class="p">,</span> <span class="s">&quot;main&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
