#!/usr/bin/env python
from git import *
import sys,getpass,ftplib,getopt
#readline is not available on windows
try:
    import readline
    gotReadline = True
except ImportError:
    gotReadline = False

class Deploy:
    deletedFiles = []
    updatedFiles = []
    
    def __init__(self):
        self.repo = Repo("")
        self.configReader = self.repo.config_reader()
    
    #raw_input with editable default values
    def raw_input_default(self,prompt, default):
        if gotReadline:
            def pre_input_hook():
                readline.insert_text(default)
                readline.redisplay()
      
            readline.set_pre_input_hook(pre_input_hook)
            try:
                return raw_input(prompt)
            finally:
                readline.set_pre_input_hook(None)
        else:
            #No readline :(
            if(default != ""):
                prompt = "[" + default + "] " + prompt
            
            val = raw_input(prompt)
            if val == "":
                val = default
            return val
    
    
    def checkFiles(self,deployVersion):
        
        if self.configReader.has_option("ftp","lastDeploy"):
            lastDeploy = self.configReader.get_value("ftp","lastDeploy")
        else:
            lastDeploy = self.repo.head.reference.log()[0].newhexsha
            
        changes = self.repo.commit(lastDeploy).diff(deployVersion)
        print "Added files:"
        for fileAdded in changes.iter_change_type('A'):
            print "  ",fileAdded.b_blob.path
            self.updatedFiles.append(fileAdded.b_blob.path)
        
        print "Updated files"
        for fileUpdated in changes.iter_change_type('M'):
            print "  ",fileUpdated.a_blob.path
            self.updatedFiles.append(fileUpdated.a_blob.path)
        
        print "Deleted files"
        for fileDeleted in changes.iter_change_type('D'):
            print "  ",fileDeleted.a_blob.path
            self.deletedFiles.append(fileDeleted.a_blob.path)
        
        print "Renamed files"
        for fileRenamed in changes.iter_change_type('R'):
            print "  From: ",fileRenamed.a_blob.path, " to ", fileRenamed.b_blob.path

    
    def connectFTP(self,rebuild_config=False):
        
        if self.configReader.has_option("ftp","remoteServer"):
            self.remoteServer = self.configReader.get_value("ftp","remoteServer")
        else:
            default = ""
            if rebuild_config:
                default = self.remoteServer
            self.remoteServer = self.raw_input_default("Server: ",default)
        
        
        if self.configReader.has_option("ftp","remoteUser"):
            self.remoteUser = self.configReader.get_value("ftp","remoteUser")
        else:
            default = ""
            if rebuild_config:
                default = self.remoteServer
            self.remoteUser = self.raw_input_default("Username: ",default)
        
        self.savePass = False
        
        if self.configReader.has_option("ftp","remotePassword"):
            self.remotePassword = self.configReader.get_value("ftp","remotePassword")
            self.savePass = True
        else:
            self.remotePassword = getpass.getpass("Password: ")
            if(self.configReader.has_option("ftp","savePass") == False):
                if raw_input("Save password (y/n):").lower() == "y":
                    self.savePass = True
        
        if self.configReader.has_option("ftp","remoteDir"):
            self.remoteDir = self.configReader.get_value("ftp","remoteDir")
        else:
            default = ""
            if rebuild_config:
                default = self.remoteServer
            self.remoteDir = self.raw_input_default("Remote directory: ","/")
        
        while self.remoteDir.startswith("/"):
            self.remoteDir = self.remoteDir[1:]
        
        while self.remoteDir.endswith("/"):
            self.remoteDir = self.remoteDir[:-1]
        
        try:
            self.ftp = ftplib.FTP(self.remoteServer,self.remoteUser,self.remotePassword)
            self.ftp.cwd("/" + self.remoteDir)
        except ftplib.all_errors as connectionError:
            print "Error connecting to server: ", connectionError
            if raw_input("Retry (y/n)?: ").lower() == "y":
                self.connectFTP(True)
            else:
                exit(255)
                
        self.rootFolder =  self.remoteDir
    
    def parseDirectories(self):
        self.dirs = {}
        for file in self.updatedFiles:
            dirs = file.split('/')[:-1]
            cwd = self.dirs
            for dir in dirs:
                if dir not in cwd:
                    cwd[dir] = {}
                    
                cwd = cwd[dir]
    
    def checkDirectories(self,cwd = "",folders = {}):
        if cwd == "":
            cwd = "/" + self.rootFolder
            folders = self.dirs
        if self.ftp:
            print "Checking folders under", cwd
            
            for dir,subFolders in folders.iteritems():
                
                print "Checking ", cwd + "/" + dir
                try:
                    self.ftp.cwd(cwd + "/" + dir)
                except:
                    print "Creating previously non-existing folder", cwd + "/" + dir
                    self.ftp.mkd(cwd + "/" + dir)
                self.checkDirectories(cwd+"/"+dir,subFolders)
                
            if cwd == "/" + self.rootFolder:
                self.ftp.cwd(cwd)
    
        
    def uploadFiles(self):
        for file in self.updatedFiles:
            print "Uploading",file
            self.ftp.storbinary("STOR " + file,open(file,'r'))
        infoWriter = self.repo.config_writer()
        infoWriter.set_value('ftp','lastDeploy',self.repo.head.reference.log()[-1].newhexsha)
        infoWriter.set_value('ftp','remoteUser',self.remoteUser)
        infoWriter.set_value('ftp','remoteDir',self.remoteDir)
        infoWriter.set_value('ftp','remoteServer',self.remoteServer)
        if self.savePass:
            infoWriter.set_value('ftp','remotePassword',self.remotePassword)

if __name__ == "__main__":
    deploy = Deploy()
    options, arguments = getopt.getopt(sys.argv[1:],"")
    if len(arguments):
        commit = arguments[0]
    else:
        commit = "HEAD"
            
    deploy.checkFiles(commit)
    deploy.connectFTP()
    deploy.parseDirectories()
    deploy.checkDirectories()
    deploy.uploadFiles()

